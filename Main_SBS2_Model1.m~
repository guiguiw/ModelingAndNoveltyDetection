%% Load data 
load('EEG_clean_54.mat')
EEG_54 = EEG_clean_54;
Data_54 = EEG_54.data;

load('EEG_clean_55.mat')
EEG_55 = EEG_clean_55;
Data_55 = EEG_55.data;

% load('EEG_clean_56.mat')
% EEG_56 = EEG_clean_56;
% Data_56 = EEG_56.data;

load('EEG_clean_65.mat')
EEG_65 = EEG_clean_65;
Data_65 = EEG_65.data;

load('EEG_clean_68.mat')
EEG_68 = EEG_clean_68;
Data_68 = EEG_68.data;

load('EEG_clean_69.mat')
EEG_69 = EEG_clean_69;
Data_69 = EEG_69.data;

load('EEG_clean_70.mat')
EEG_70 = EEG_clean_70;
Data_70 = EEG_70.data;

load('EEG_clean_82.mat')
EEG_82 = EEG_clean_82;
Data_82 = EEG_82.data;

load('EEG_clean_83.mat')
EEG_83 = EEG_clean_83;
Data_83 = EEG_83.data;

load('EEG_clean_85.mat')
EEG_85 = EEG_clean_85;
Data_85 = EEG_85.data;

load('EEG_clean_86.mat')
EEG_86 = EEG_clean_86;
Data_86 = EEG_86.data;

load('EEG_clean_87.mat')
EEG_87 = EEG_clean_87;
Data_87 = EEG_87.data;

load('EEG_clean_90.mat')
EEG_90 = EEG_clean_90;
Data_90 = EEG_90.data;

load('EEG_clean_92.mat')
EEG_92 = EEG_clean_92;
Data_92 = EEG_92.data;

load('EEG_clean_93.mat')
EEG_93 = EEG_clean_93;
Data_93 = EEG_93.data;

load('EEG_clean_94.mat')
EEG_94 = EEG_clean_94;
Data_94 = EEG_94.data;


% load('EEG_clean_95_dont_use.mat')
% EEG_95 = EEG_clean_95_dont_use;
% Data_95 = EEG_95.data;

load('EEG_clean_97.mat')
EEG_97 = EEG_clean_97;
Data_97 = EEG_97.data;

load('EEG_clean_98.mat')
EEG_98 = EEG_clean_98;
Data_98 = EEG_98.data;

load('EEG_clean_99.mat')
EEG_99 = EEG_clean_99;
Data_99 = EEG_99.data;

load('EEG_clean_100.mat')
EEG_100 = EEG_clean_100;
Data_100 = EEG_100.data;

load('EEG_clean_101.mat')
EEG_101 = EEG_clean_101;
Data_101 = EEG_101.data;

load('EEG_clean_103.mat')
EEG_103 = EEG_clean_103;
Data_103 = EEG_103.data;

load('EEG_clean_104.mat')
EEG_104 = EEG_clean_104;
Data_104 = EEG_104.data;

load('EEG_clean_105.mat')
EEG_105 = EEG_clean_105;
Data_105 = EEG_105.data;
%% 
clear length_window Data title plot_name
length_window = EEG_54.srate;
Data_pre = {Data_54, Data_55, Data_65, Data_68, Data_69, Data_70, Data_82, Data_83, Data_85, Data_86, Data_87, Data_90, Data_92, Data_93, Data_94, Data_97, Data_98, Data_99, Data_100,Data_101,Data_103,Data_104,Data_105};
%Data2 = {Data_54, Data_55, Data_56, Data_65, Data_68, Data_69, Data_70, Data_82, Data_83, Data_85, Data_86, Data_87, Data_90, Data_92, Data_93, Data_94, EEG_clean_95_dont_use, Data_97, Data_98, Data_99, Data_100,Data_101,Data_103,Data_104,Data_105};
Data_IED_pre = {Data_54,Data_65,Data_70,Data_83,Data_86, Data_90, Data_100};
Data_non_IED_pre = {Data_55,  Data_68, Data_69, Data_82, Data_85, Data_87, Data_92, Data_93, Data_94, Data_97, Data_98, Data_99, Data_101, Data_103, Data_104, Data_105};
%Data_pre = {Data_02_pre, Data_04_pre, Data_05_pre, Data_07_pre, Data_10_pre, Data_13_pre, Data_14_pre, Data_16_pre, Data_20_pre, Data_21_pre,Data_22_pre};
%seizure = {seizure_02, seizure_04, seizure_05, seizure_07, seizure_10,seizure_13, seizure_14, seizure_16, seizure_20, seizure_21, seizure_22};
title_plot = {'Patient 54', 'Patient 55', 'Patient 65', 'Patient 68','Patient 69', 'Patient 70', 'Patient 82', 'Patient 83', 'Patient 85', 'Patient 86', 'Patient 87','Patient 90', 'Patient 92', 'Patient 93', 'Patient 94', 'Patient 97', 'Patient 98', 'Patient 99', 'Patient 100', 'Patient 101', 'Patient 103', 'Patient 104', 'Patient 105'};
title_plot2 = {'Patient 54',  'Patient 65', 'Patient 70',  'Patient 83', 'Patient 86','Patient 90', 'Patient 100'};

plot_name = {'Chb54', 'Chb55',  'Chb65', 'Chb68', 'Chb69','Chb70', 'Chb82', 'Chb83', 'Chb85', 'Chb86', 'Chb87', 'Chb90', 'Chb92', 'Chb93', 'Chb94', 'Chb97', 'Chb98','Chb99', 'Chb100', 'Chb101', 'Chb103', 'Chb104', 'Chb105'};

%% Devide all data in every channel by the MAD of every channel
Data = {};
Data_IED = {};
Data_non_IED = {};

for i = 1:length(Data_pre)
    data = Data_pre{1,i};
    
    M = median(data,2);
    MAD = median(abs((data - M)),2);
        
    data_new = data./MAD;
    Data{1,i} = data_new;
end
for i = 1:length(Data_IED_pre)
    data = Data_pre{1,i};
    
    M = median(data,2);
    MAD = median(abs((data - M)),2);
        
    data_new = data./MAD;
    Data_IED{1,i} = data_new;
end

for i = 1:length(Data_non_IED_pre)
    data = Data_non_IED_pre{1,i};
    
    M = median(data,2);
    MAD = median(abs((data - M)),2);
        
    data_new = data./MAD;
    Data_non_IED{1,i} = data_new;
end


%% Make the features for spectral
nwin = [];
nfft = nwin;
num_sec = 1;
sample_freq = 128;
length_window = sample_freq*num_sec;
noverlap = nwin * 0.5;
num_chan = 14;

% GET TEST DATA
 j = 1;
 Feature_cell = {};
 %Feature_norm_cell = {};
 %PSE_cell = {};
for k = 1:length(Data_IED)
    data = Data_IED{1,k};
    num_window = floor(size(data,2)/length_window);
    Feature_matrix = zeros(6*num_chan,num_window);
    %Feature_matrix_norm = zeros(5*num_chan,num_window);
    %PSE_matrix = zeros(num_chan,num_window);
    j = 1;
    for i = 1:num_window
        % Get "window" of the data to summerize
        eeg_data = data(:,j:j+length_window-1)';  
        % Get the features
        [E, E_normal, PSE] = getFeatures(eeg_data, nwin, sample_freq, length_window, num_chan);
        Feature_matrix(:,i) = E;
        %Feature_matrix_norm(:,i) = E_normal;
        %PSE_matrix(:,i) = PSE;
        j = j+length_window;
    end
    
    Feature_cell{1,k} = Feature_matrix;
    %Feature_norm_cell{1,k} = Feature_matrix_norm;
    %PSE_cell{1,k} = PSE_matrix; 
    
end    

% GET CLEAN DATA
  j = 1;
 Feature_cell_train = {};
 %Feature_norm_cell_train = {};
 %PSE_cell_train = {};
for k = 1:length(Data_non_IED)
    data = Data_non_IED{1,k};
    num_window = floor(size(data,2)/length_window);
    Feature_matrix = zeros(6*num_chan,num_window);
    %Feature_matrix_norm = zeros(5*num_chan,num_window);
    %PSE_matrix = zeros(num_chan,num_window);
    j = 1;
    for i = 1:num_window
        % Get "window" of the data to summerize
        eeg_data = data(:,j:j+length_window-1)';  
        % Get the features
        [E, E_normal, PSE] = getFeatures(eeg_data, nwin, sample_freq, length_window, num_chan);
        Feature_matrix(:,i) = E;
%         Feature_matrix_norm(:,i) = E_normal;
%         PSE_matrix(:,i) = PSE;
        j = j+length_window;
    end
    
    Feature_cell_train{1,k} = Feature_matrix;
%     Feature_norm_cell_train{1,k} = Feature_matrix_norm;
%     PSE_cell_train{1,k} = PSE_matrix;    
end 



%% Look at all the feature sets for both IED and non IED patients

all_features = 84;
Data_non_features = [];
Data_non_features_mean = zeros(all_features,1);
for i = 1:length(Feature_cell_train)
    Data_non_features = [Data_non_features Feature_cell_train{1,i}];
end
Data_non_features_mean = mean(Data_non_features,2);

conf_int_train_features = zeros(all_features,1);
for i = 1:all_features
    Z = 1.960;
    n_train = length(Data_non_features(i,:));
    std_train = std(Data_non_features(i,:)');
    conf_int_train_features(i) = Z * std_train/sqrt(n_train);
end
% conf_int_train_features = conf_int_train_features';


Data_with_features = [];
Data_with_features_mean = zeros(all_features,1);
for i = 1:length(Feature_cell)
    
    Data_with_features = [Data_with_features Feature_cell{1,i}];
end
Data_with_features_mean = mean(Data_with_features,2);

conf_int_test_features = zeros(all_features,1);
for i = 1:all_features
    n_test = length(Data_with_features(i,:));
    std_test = std(Data_with_features(i,:)');
    conf_int_test_features(i) = Z * std_test/sqrt(n_test);
end 
% conf_int_test_features = conf_int_test_features';

%% Split the data to train and test set

all_features = 84;
Data_train = [];
for i = 1:9 %length(Feature_cell_train)
    Data_train = [Data_train Feature_cell_train{1,i}];
end

Data_test_non = [];
for i = 10:length(Feature_cell_train)
    Data_test_non = [Data_test_non Feature_cell_train{1,i}];
end

Data_test_with = [];
for i = 1:length(Feature_cell)
    Data_test_with = [Data_test_with Feature_cell{1,i}];
end

%%



